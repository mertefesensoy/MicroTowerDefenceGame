default_platform(:ios)

platform :ios do
  before_all do
    ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"
    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "3"

    # Load .env.match locally (never commit it)
    if File.exist?(".env.match")
      require "dotenv"
      Dotenv.load(".env.match")
    end

    # Guard against missing critical env vars (fail fast)
    UI.user_error!("Missing MATCH_GIT_URL") unless ENV["MATCH_GIT_URL"]
    UI.user_error!("Missing MATCH_GIT_BASIC_AUTHORIZATION") unless ENV["MATCH_GIT_BASIC_AUTHORIZATION"]
    UI.user_error!("Missing MATCH_PASSWORD") unless ENV["MATCH_PASSWORD"]
    UI.user_error!("Missing DEVELOPER_PORTAL_TEAM_ID") unless ENV["DEVELOPER_PORTAL_TEAM_ID"]
  end

  def asc_api_key
    UI.user_error!("Missing ASC_KEY_ID") unless ENV["ASC_KEY_ID"]
    UI.user_error!("Missing ASC_ISSUER_ID") unless ENV["ASC_ISSUER_ID"]
    UI.user_error!("Missing ASC_KEY_P8_B64") unless ENV["ASC_KEY_P8_B64"]
    
    app_store_connect_api_key(
      key_id: ENV.fetch("ASC_KEY_ID"),
      issuer_id: ENV.fetch("ASC_ISSUER_ID"),
      key_content: Base64.decode64(ENV.fetch("ASC_KEY_P8_B64")),
      in_house: false
    )
  end

  desc "One-time setup: create/sign certs & profiles and push to match repo"
  lane :bootstrap_signing do
    setup_ci if ENV["CI"]

    match(
      type: "appstore",
      app_identifier: "com.mertefesensoy.MicroTowerDefenceGame",
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION"),
      team_id: ENV.fetch("DEVELOPER_PORTAL_TEAM_ID"),
      readonly: false
    )
  end

  desc "Build + upload to TestFlight"
  lane :beta do
    setup_ci if ENV["CI"]

    # Fetch signing material without modifying repo
    match(
      type: "appstore",
      app_identifier: "com.mertefesensoy.MicroTowerDefenceGame",
      git_url: ENV.fetch("MATCH_GIT_URL"),
      git_basic_authorization: ENV.fetch("MATCH_GIT_BASIC_AUTHORIZATION"),
      team_id: ENV.fetch("DEVELOPER_PORTAL_TEAM_ID"),
      readonly: true
    )

    build_app(
      scheme: "MicroTowerDefenceGame",
      export_method: "app-store"
    )

    upload_to_testflight(
      api_key: asc_api_key,
      skip_waiting_for_build_processing: false
    )
  end
end
